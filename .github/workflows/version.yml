name: Version Management

on:
  workflow_dispatch:
    inputs:
      version-type:
        description: 'Version type'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
        - prerelease
      prerelease-id:
        description: 'Prerelease identifier (for prerelease only)'
        required: false
        default: 'beta'
        type: choice
        options:
        - alpha
        - beta
        - rc
      custom-version:
        description: 'Custom version (overrides version-type)'
        required: false
        type: string

jobs:
  version:
    runs-on: macos-latest
    
    outputs:
      new-version: ${{ steps.version.outputs.new-version }}
      should-release: ${{ steps.version.outputs.should-release }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

    - name: Install dependencies
      run: npm ci

    - name: Get current version
      id: current
      run: |
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "current-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $CURRENT_VERSION"

    - name: Calculate new version
      id: version
      run: |
        set -e
        
        if [ -n "${{ github.event.inputs.custom-version }}" ]; then
          NEW_VERSION="${{ github.event.inputs.custom-version }}"
          echo "Using custom version: $NEW_VERSION"
        else
          VERSION_TYPE="${{ github.event.inputs.version-type }}"
          
          if [ "$VERSION_TYPE" = "prerelease" ]; then
            PRERELEASE_ID="${{ github.event.inputs.prerelease-id }}"
            # æ£€æŸ¥å½“å‰ç‰ˆæœ¬æ˜¯å¦å·²ç»æ˜¯prerelease
            CURRENT_VERSION="${{ steps.current.outputs.current-version }}"
            if [[ "$CURRENT_VERSION" == *"-$PRERELEASE_ID"* ]]; then
              # å¢åŠ prereleaseå·ç 
              NEW_VERSION=$(npm version prerelease --no-git-tag-version --preid=$PRERELEASE_ID)
            else
              # åˆ›å»ºæ–°çš„prerelease
              NEW_VERSION=$(npm version pre${{ github.event.inputs.version-type }} --no-git-tag-version --preid=$PRERELEASE_ID)
            fi
          else
            NEW_VERSION=$(npm version $VERSION_TYPE --no-git-tag-version)
          fi
          
          # ç§»é™¤ 'v' å‰ç¼€
          NEW_VERSION=${NEW_VERSION#v}
        fi
        
        echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "should-release=true" >> $GITHUB_OUTPUT
        echo "New version will be: $NEW_VERSION"

    - name: Update package.json version
      if: github.event.inputs.custom-version != ''
      run: |
        npm version ${{ steps.version.outputs.new-version }} --no-git-tag-version

    - name: Run tests
      run: |
        npm run lint
        npm run type-check

    - name: Update CHANGELOG.md
      run: |
        NEW_VERSION="${{ steps.version.outputs.new-version }}"
        DATE=$(date +"%Y-%m-%d")
        
        # åˆ›å»º CHANGELOG.md å¦‚æœä¸å­˜åœ¨
        if [ ! -f CHANGELOG.md ]; then
          cat > CHANGELOG.md << EOF
        # æ›´æ–°æ—¥å¿—
        
        æœ¬æ–‡æ¡£è®°å½•äº†é¡¹ç›®çš„æ‰€æœ‰é‡è¦æ›´æ”¹ã€‚
        
        æ ¼å¼åŸºäº [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)ï¼Œ
        é¡¹ç›®éµå¾ª [è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶](https://semver.org/lang/zh-CN/)ã€‚
        
        EOF
        fi
        
        # å‡†å¤‡æ›´æ–°æ—¥å¿—æ¡ç›®
        cat > temp_changelog.md << EOF
        ## [$NEW_VERSION] - $DATE
        
        ### æ–°å¢
        - å¾…è¡¥å……æ–°åŠŸèƒ½æè¿°
        
        ### ä¿®æ”¹
        - å¾…è¡¥å……åŠŸèƒ½æ”¹è¿›æè¿°
        
        ### ä¿®å¤
        - å¾…è¡¥å……bugä¿®å¤æè¿°
        
        ### å·²çŸ¥é—®é¢˜
        - å¦‚æœ‰å·²çŸ¥é—®é¢˜è¯·åœ¨æ­¤åˆ—å‡º
        
        EOF
        
        # å°†æ–°æ¡ç›®æ’å…¥åˆ° CHANGELOG.md ä¸­
        if grep -q "## \[" CHANGELOG.md; then
          # å¦‚æœå·²æœ‰ç‰ˆæœ¬è®°å½•ï¼Œæ’å…¥åˆ°ç¬¬ä¸€ä¸ªç‰ˆæœ¬ä¹‹å‰
          sed -i '' '/^## \[/i\
        '"$(cat temp_changelog.md)"'
        ' CHANGELOG.md
        else
          # å¦‚æœæ²¡æœ‰ç‰ˆæœ¬è®°å½•ï¼Œè¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾
          cat temp_changelog.md >> CHANGELOG.md
        fi
        
        rm temp_changelog.md

    - name: Commit changes
      run: |
        NEW_VERSION="${{ steps.version.outputs.new-version }}"
        
        git add package.json package-lock.json CHANGELOG.md
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        git commit -m "chore: bump version to v$NEW_VERSION

        ğŸ“ Version bump from ${{ steps.current.outputs.current-version }} to $NEW_VERSION
        
        ğŸ”– Generated with [Claude Code](https://claude.ai/code)
        
        Co-Authored-By: Claude <noreply@anthropic.com>"

    - name: Create and push tag
      run: |
        NEW_VERSION="${{ steps.version.outputs.new-version }}"
        
        # åˆ›å»ºå¸¦æ³¨é‡Šçš„æ ‡ç­¾
        git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION

        ğŸ‰ ScreenWatcher $NEW_VERSION å‘å¸ƒ
        
        ## ä¸»è¦æ›´æ”¹
        - è¯·æŸ¥çœ‹ CHANGELOG.md äº†è§£è¯¦ç»†æ›´æ”¹
        - æ­¤ç‰ˆæœ¬é€šè¿‡è‡ªåŠ¨åŒ–å·¥ä½œæµåˆ›å»º
        
        ## ä¸‹è½½
        - macOS Intel: ScreenWatcher-$NEW_VERSION-x64.dmg  
        - macOS Apple Silicon: ScreenWatcher-$NEW_VERSION-arm64.dmg
        - é€šç”¨ç‰ˆæœ¬: ScreenWatcher-$NEW_VERSION-universal.dmg
        
        ğŸ”– Generated with [Claude Code](https://claude.ai/code)
        
        Co-Authored-By: Claude <noreply@anthropic.com>"
        
        echo "Tag v$NEW_VERSION created"

    - name: Push changes and tags
      run: |
        git push origin ${{ github.ref_name }}
        git push origin --tags
        
        echo "âœ… Version ${{ steps.version.outputs.new-version }} committed and tagged"
        echo "ğŸš€ Release workflow will be triggered automatically"

    - name: Create release summary
      run: |
        NEW_VERSION="${{ steps.version.outputs.new-version }}"
        
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # ğŸ‰ ç‰ˆæœ¬æ›´æ–°å®Œæˆ
        
        ## ç‰ˆæœ¬ä¿¡æ¯
        - **åŸç‰ˆæœ¬**: ${{ steps.current.outputs.current-version }}
        - **æ–°ç‰ˆæœ¬**: $NEW_VERSION
        - **æ›´æ–°ç±»å‹**: ${{ github.event.inputs.version-type }}
        
        ## åç»­æ“ä½œ
        1. âœ… ç‰ˆæœ¬å·å·²æ›´æ–°åˆ° package.json
        2. âœ… CHANGELOG.md å·²æ›´æ–°ï¼ˆè¯·æ‰‹åŠ¨å®Œå–„æ›´æ–°å†…å®¹ï¼‰
        3. âœ… Git æ ‡ç­¾ v$NEW_VERSION å·²åˆ›å»º
        4. ğŸ”„ Release å·¥ä½œæµå°†è‡ªåŠ¨è§¦å‘
        
        ## é“¾æ¥
        - ğŸ“¦ [æŸ¥çœ‹å‘å¸ƒé¡µé¢](../../releases)
        - ğŸ”¨ [æŸ¥çœ‹æ„å»ºçŠ¶æ€](../../actions/workflows/release.yml)
        - ğŸ“ [ç¼–è¾‘æ›´æ–°æ—¥å¿—](../../edit/${{ github.ref_name }}/CHANGELOG.md)
        
        ## æé†’
        è¯·åœ¨å‘å¸ƒå‰å®Œå–„ CHANGELOG.md ä¸­çš„æ›´æ–°å†…å®¹æè¿°ã€‚
        EOF

  # å¯é€‰ï¼šè‡ªåŠ¨åˆ›å»º Pull Request æ¥æ›´æ–° CHANGELOG
  create-changelog-pr:
    needs: version
    if: needs.version.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref_name }}
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Create PR for CHANGELOG update
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "docs: update CHANGELOG for v${{ needs.version.outputs.new-version }}"
        title: "ğŸ“ å®Œå–„ v${{ needs.version.outputs.new-version }} æ›´æ–°æ—¥å¿—"
        body: |
          ## ğŸ“ æ›´æ–°æ—¥å¿—å®Œå–„
          
          æ­¤ PR æ˜¯ä¸ºäº†å®Œå–„ v${{ needs.version.outputs.new-version }} ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—ã€‚
          
          ### è¯·å®Œæˆä»¥ä¸‹å†…å®¹ï¼š
          
          - [ ] åœ¨ `CHANGELOG.md` ä¸­è¡¥å……å…·ä½“çš„æ–°åŠŸèƒ½æè¿°
          - [ ] æ·»åŠ é‡è¦çš„åŠŸèƒ½æ”¹è¿›è¯´æ˜  
          - [ ] åˆ—å‡ºä¿®å¤çš„é—®é¢˜å’Œbug
          - [ ] æ ‡æ³¨ä»»ä½•ç ´åæ€§æ›´æ”¹
          - [ ] æ·»åŠ å‡çº§æ³¨æ„äº‹é¡¹ï¼ˆå¦‚éœ€è¦ï¼‰
          
          ### å½“å‰ç‰ˆæœ¬ä¿¡æ¯
          - **ç‰ˆæœ¬**: v${{ needs.version.outputs.new-version }}
          - **ç±»å‹**: ${{ github.event.inputs.version-type }}
          - **æ ‡ç­¾**: [v${{ needs.version.outputs.new-version }}](../../releases/tag/v${{ needs.version.outputs.new-version }})
          
          å®Œå–„æ›´æ–°æ—¥å¿—åï¼Œæ­¤ PR å°†å¸®åŠ©ç”¨æˆ·æ›´å¥½åœ°äº†è§£ç‰ˆæœ¬æ›´æ–°å†…å®¹ã€‚
          
          ---
          ğŸ¤– æ­¤ PR ç”±ç‰ˆæœ¬ç®¡ç†å·¥ä½œæµè‡ªåŠ¨åˆ›å»º
        branch: changelog/v${{ needs.version.outputs.new-version }}
        delete-branch: true